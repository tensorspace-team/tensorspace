<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Preprocessing - TensorFlow.js</title>

    <meta name="description" content="Documentation page of TensorSpace.js">
    <meta name="author" content="syt123450 / https://github.com/syt123450">
    <meta name="author" content="zchholmes / https://github.com/zchholmes">
    <link rel='icon' href='../../assets/img/common/logo.ico' type=‘image/x-ico’>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="../../assets/jslib/jquery.min.js"></script>
    <link rel="stylesheet" href="../../assets/csslib/bootstrap.min.css">
    <script src="../../assets/jslib/bootstrap.min.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/material.fonts.css">
    <link rel="stylesheet" href="../../assets/csslib/material.min.css">
    <script src="../../assets/jslib/material.min.js"></script>

    <script src="../../js/websiteUtil.js"></script>
    <script src="../../js/commonDoc.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/mono-blue.css">
    <script src="../../assets/jslib/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/commonDoc.css">
    <link rel="stylesheet" href="../../css/docsFont.css">

</head>
<body>

<nav>

    <div class="container">

        <div id="logo">
            <a href="../../index.html">
                <img src="../../assets/img/common/logoSmall.png">
                <div>TensorSpace.js</div>
            </a>
        </div>

        <ul class="hidden-xs">
            <!--<li class="now"><a href="index.html">Documentation</a></li>-->
             <li class="now"><a href="startIntro.html">Documentation</a></li>
            <li><a href="../playground/index.html">Playground</a></li>
            <!--<li><a href="../gallery.html">Gallery</a></li>-->
            <li><a href="../../index.html#download">Download</a></li>
            <!--<li><a href="../developer.html">Developer</a></li>-->

            <a href="https://github.com/tensorspace-team/tensorspace" class="github-corner" aria-label="View source on Github">
                <svg viewBox="0 0 250 250" aria-hidden="true">
                    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                          fill="currentColor" class="octo-body"></path>
                </svg>
            </a>

        </ul>

    </div>

    <ul id="more" class="nav nav-tabs visible-xs">
        <li>
            <a>
                <span class="glyphicon glyphicon-th-large"></span>
            </a>
        </li>
    </ul>

    <ul id="nav-collapse" class="nav navbar-nav">
        <li><a href="../../index.html">Home</a></li>
        <li><a href="../../index.html#download">Download</a></li>
        <!--<li><a href="../developer.html">Developer</a></li>-->
    </ul>

    <div class="language">
        <div class="selected">
            <div>EN</div>
        </div>
        <div>
            <div><a href="preTfjs_zh.html">中</a></div>
        </div>
    </div>

</nav>

<div id="smallGuide">
    <span class="glyphicon glyphicon-list"></span>
</div>

<div id="hideNav">

    <img id="ContentLogo" src="../../assets/img/docs/logo_white.png">

    <header>TensorSpace.js</header>

    <div>
        <div id="startLabelS">
            Getting Start<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="startS">
            <li><a href="startIntro.html">Introduction</a></li>
            <li><a href="startSystem.html">System Requirements</a></li>
            <li><a href="startInstall.html">Installation</a></li>
            <li><a href="startHello.html">TensorSpace Hello World</a></li>
            <li><a href="startOther.html">More Resources</a></li>
        </ul>
    </div>
    <div>
        <div id="basicLabelS">
            Basic Concepts<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="basicS">
            <li><a href="basicIntro.html">Introduction</a></li>
            <li><a href="basicModel.html">Model</a></li>
            <li><a href="basicLayer.html">Layer</a></li>
            <li><a href="basicPreprocessing.html">Preprocessing</a></li>
            <li><a href="basicLoad.html">Load Model</a></li>
            <li><a href="basicPredict.html">Predict</a></li>
            <li><a href="basicClose.html">Close Button</a></li>
            <li><a href="basicPaging.html">Paging</a></li>
            <li><a href="basicMetrics.html">Layer Metrics</a></li>
            <li><a href="basicDimension.html">Layer Dimension</a></li>
            <li><a href="basicColor.html">Layer Color</a></li>
            <li><a href="basicStats.html">Stats</a></li>
        </ul>
    </div>
    <div class="open initLabel">
        <div id="preprocessingLabelS">
            Model Preprocessing<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="preprocessingS">
            <li><a href="preIntro.html">Introduction</a></li>
            <li><a href="preTf.html">TensorFlow</a></li>
            <li><a href="preKeras.html">Keras</a></li>
            <li><a href="preTfKeras.html">tf.keras</a></li>
            <li class="nowLabel">TensorFlow.js</li>
        </ul>
    </div>
    <div>
        <div id="modelLabelS">
            Models<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="modelS">
            <li><a href="modelIntro.html">Introduction</a></li>
            <li><a href="modelFunctional.html">Function Model</a></li>
            <li><a href="modelSequential.html">Sequential Model</a></li>
        </ul>
    </div>
    <div>
        <div id="layerLabelS">
            Layers<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="layerS">
            <li><a href="layerIntro.html">Introduction</a></li>
            <li><a href="layerConv1d.html">Conv1d</a></li>
            <li><a href="layerConv2d.html">Conv2d</a></li>
            <li><a href="layerTranspose.html">Conv2dTranspose</a></li>
            <li><a href="layerCropping1d.html">Cropping1d</a></li>
            <li><a href="layerCropping2d.html">Cropping2d</a></li>
            <li><a href="layerDense.html">Dense</a></li>
            <li><a href="layerFlatten.html">Flatten</a></li>
            <li><a href="layerGlobalPooling1d.html">GlobalPooling1d</a></li>
            <li><a href="layerGlobalPooling2d.html">GlobalPooling2d</a></li>
            <li><a href="layerPadding1d.html">Padding1d</a></li>
            <li><a href="layerPadding2d.html">Padding2d</a></li>
            <li><a href="layerPooling1d.html">Pooling1d</a></li>
            <li><a href="layerPooling2d.html">Pooling2d</a></li>
            <li><a href="layerReshape.html">Reshape</a></li>
            <li><a href="layerUpSampling1d.html">UpSampling1d</a></li>
            <li><a href="layerUpSampling2d.html">UpSampling2d</a></li>
            <li><a href="layerActivation1d.html">Activation1d</a></li>
            <li><a href="layerActivation2d.html">Activation2d</a></li>
            <li><a href="layerActivation3d.html">Activation3d</a></li>
            <li><a href="layerLayer1d.html">Layer1d</a></li>
            <li><a href="layerLayer2d.html">Layer2d</a></li>
            <li><a href="layerLayer3d.html">Layer3d</a></li>
            <li><a href="layerInput1d.html">Input1d</a></li>
            <li><a href="layerGreyscaleInput.html">GreyscaleInput</a></li>
            <li><a href="layerRGBInput.html">RGBInput</a></li>
            <li><a href="layerOutput1d.html">Output1d</a></li>
            <li><a href="layerOutputDetect.html">OutputDetection</a></li>
            <li><a href="layerYoloGrid.html">YoloGrid</a></li>
        </ul>
    </div>
    <div>
        <div id="mergeLabelS">
            Merge Function<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="mergeS">
            <li><a href="mergeIntro.html">Introduction</a></li>
            <li><a href="mergeAdd.html">Add</a></li>
            <li><a href="mergeSub.html">Subtract</a></li>
            <li><a href="mergeMul.html">Multiply</a></li>
            <li><a href="mergeMax.html">Maximum</a></li>
            <li><a href="mergeAver.html">Average</a></li>
            <li><a href="mergeConcate.html">Concatenate</a></li>
        </ul>
    </div>

    <img id="close" src="../../assets/img/docs/close.png">

</div>

<div id="curtain"></div>

<div id="documentArea" class="container">

    <aside>
        <div>
            <div id="startLabel">
                Getting Start<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="start">
                <li><a href="startIntro.html">Introduction</a></li>
                <li><a href="startSystem.html">System Requirements</a></li>
                <li><a href="startInstall.html">Installation</a></li>
                <li><a href="startHello.html">TensorSpace Hello World</a></li>
                <li><a href="startOther.html">More Resources</a></li>
            </ul>
        </div>
        <div>
            <div id="basicLabel">
                Basic Concepts<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="basic">
                <li><a href="basicIntro.html">Introduction</a></li>
                <li><a href="basicModel.html">Model</a></li>
                <li><a href="basicLayer.html">Layer</a></li>
                <li><a href="basicPreprocessing.html">Preprocessing</a></li>
                <li><a href="basicLoad.html">Load Model</a></li>
                <li><a href="basicPredict.html">Predict</a></li>
                <li><a href="basicClose.html">Close Button</a></li>
                <li><a href="basicPaging.html">Paging</a></li>
                <li><a href="basicMetrics.html">Layer Metrics</a></li>
                <li><a href="basicDimension.html">Layer Dimension</a></li>
                <li><a href="basicColor.html">Layer Color</a></li>
                <li><a href="basicStats.html">Stats</a></li>
            </ul>
        </div>
        <div class="open initLabel">
            <div id="preprocessingLabel">
                Model Preprocessing<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="preprocessing">
                <li><a href="preIntro.html">Introduction</a></li>
                <li><a href="preTf.html">TensorFlow</a></li>
                <li><a href="preKeras.html">Keras</a></li>
                <li><a href="preTfKeras.html">tf.keras</a></li>
                <li class="nowLabel">TensorFlow.js</li>
            </ul>
        </div>
        <div>
            <div id="modelLabel">
                Models<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="model">
                <li><a href="modelIntro.html">Introduction</a></li>
                <li><a href="modelFunctional.html">Function Model</a></li>
                <li><a href="modelSequential.html">Sequential Model</a></li>
            </ul>
        </div>
        <div>
            <div id="layerLabel">
                Layers<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="layer">
                <li><a href="layerIntro.html">Introduction</a></li>
                <li><a href="layerConv1d.html">Conv1d</a></li>
                <li><a href="layerConv2d.html">Conv2d</a></li>
                <li><a href="layerTranspose.html">Conv2dTranspose</a></li>
                <li><a href="layerCropping1d.html">Cropping1d</a></li>
                <li><a href="layerCropping2d.html">Cropping2d</a></li>
                <li><a href="layerDense.html">Dense</a></li>
                <li><a href="layerFlatten.html">Flatten</a></li>
                <li><a href="layerGlobalPooling1d.html">GlobalPooling1d</a></li>
                <li><a href="layerGlobalPooling2d.html">GlobalPooling2d</a></li>
                <li><a href="layerPadding1d.html">Padding1d</a></li>
                <li><a href="layerPadding2d.html">Padding2d</a></li>
                <li><a href="layerPooling1d.html">Pooling1d</a></li>
                <li><a href="layerPooling2d.html">Pooling2d</a></li>
                <li><a href="layerReshape.html">Reshape</a></li>
                <li><a href="layerUpSampling1d.html">UpSampling1d</a></li>
                <li><a href="layerUpSampling2d.html">UpSampling2d</a></li>
                <li><a href="layerActivation1d.html">Activation1d</a></li>
                <li><a href="layerActivation2d.html">Activation2d</a></li>
                <li><a href="layerActivation3d.html">Activation3d</a></li>
                <li><a href="layerLayer1d.html">Layer1d</a></li>
                <li><a href="layerLayer2d.html">Layer2d</a></li>
                <li><a href="layerLayer3d.html">Layer3d</a></li>
                <li><a href="layerInput1d.html">Input1d</a></li>
                <li><a href="layerGreyscaleInput.html">GreyscaleInput</a></li>
                <li><a href="layerRGBInput.html">RGBInput</a></li>
                <li><a href="layerOutput1d.html">Output1d</a></li>
                <li><a href="layerOutputDetect.html">OutputDetection</a></li>
                <li><a href="layerYoloGrid.html">YoloGrid</a></li>
            </ul>
        </div>
        <div>
            <div id="mergeLabel">
                Merge Function<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="merge">
                <li><a href="mergeIntro.html">Introduction</a></li>
                <li><a href="mergeAdd.html">Add</a></li>
                <li><a href="mergeSub.html">Subtract</a></li>
                <li><a href="mergeMul.html">Multiply</a></li>
                <li><a href="mergeMax.html">Maximum</a></li>
                <li><a href="mergeAver.html">Average</a></li>
                <li><a href="mergeConcate.html">Concatenate</a></li>
            </ul>
        </div>
    </aside>

    <main>
        <img class="logo-img" src="../../assets/img/docs/Logos/tfjs.png">
        <header>Preprocessing TensorFlow.js Model</header>
        <div>In the following chapter, we will introduce how to preprocess a TensorFlow.js (AKA. "tfjs") model before applying TensorSpace, which requires the intermediate outputs from internal layers.</div>
        <div>If you are new for a tfjs model, we highly recommend you to go through the <a href="https://js.tensorflow.org/tutorials/">guide</a> from TensorFlow.js first.</div>
        <div>The sample files we used in the tutorial are listed below:</div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/createTfjsModel.html">
                createTfjsModel.html
            </a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/loadTfjsModel.html">
                loadTfjsModel.html
            </a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/tree/master/docs/preprocess/TensorFlowjs/models">
                all model files
            </a>
        </div>
        <div>For the tutorial, make sure to install and import TensorFlow.js.</div>
        <div>To install TensorFlow.js, just use the NPM install:</div>
        <div class="code-snippet">
            <pre><code class="Bash">npm install @tensorflow/tfjs</code></pre>
        </div>
        <div>To import TensorFlow.js, include tf.min.js in html.</div>
        <div class="code-snippet">
            <pre><code class="html">&lt;script src="libs/tf.min.js"&gt;&lt;/script&gt;</code></pre>
        </div>
        <div>For preprocessing a tfjs model, we have a general process like:</div>
        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_general_process.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 1</span> - Steps to preprocess a TensorFlow.js model
        </div>
        <div>In this tutorial, we will introduce the process in two use cases:</div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#toTrain">1. To train a TensorSpace compatible tfjs model</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#toConvert">2. To convert an existing tfjs model to make it compatible with TensorSpace</a>
        </div>
        <div>All cases use LeNet with MNIST dataset as an example.</div>

        <div id="toTrain" class="sub-title">1 To train a TensorSpace compatible tfjs model</div>

        <div><span class="span_bold">1.1 Train a new model</span></div>

        <div>If you do not have any existed model in hands, let's train a TensorFlow.js model together.</div>
        <div>First, let's take a look at the LeNet structure:</div>

        <img class="tag-img-vertical" src="../../assets/img/docs/General/LeNet_Structure.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 2</span> - LeNet structure
        </div>
        <div>By following the structure, we can build a basic model:</div>
        <div class="code-snippet">
            <pre><code class="Javascript">// Initialize layer.
const input = tf.input({shape: [28, 28, 1]});
const conv1 = tf.layers.conv2d({
    kernelSize: 5,
    filters: 6,
    strides: 1,
    activation: 'relu',
    kernelInitializer: 'VarianceScaling',
    name: 'MyConv2D_1'
});
const maxPool1 = tf.layers.maxPooling2d({
    poolSize: [2, 2],
    strides: [2, 2],
    name: 'MyMaxPooling_1'
});
const conv2 = tf.layers.conv2d({
    kernelSize: 5,
    filters: 16,
    strides: 1,
    activation: 'relu',
    kernelInitializer: 'VarianceScaling',
    name: 'MyConv2D_2'
});
const maxPool2 = tf.layers.maxPooling2d({
    poolSize: [2, 2],
    strides: [2, 2],
    name: 'MyMaxPooling_2'
});

const flatten = tf.layers.flatten();

const dense1 = tf.layers.dense({
    units: 120,
    kernelInitializer: 'VarianceScaling',
    activation: 'relu',
    name: 'MyDense_1'
});
const dense2 = tf.layers.dense({
    units: 84,
    kernelInitializer: 'VarianceScaling',
    activation: 'relu',
    name: 'MyDense_2'
});
const softmaxLayer = tf.layers.dense({
    units: 10,
    kernelInitializer: 'VarianceScaling',
    activation: 'softmax',
    name: 'MySoftMax'
});

// Make layer connection.
const conv1Output = conv1.apply(input);
const maxPool1Output = maxPool1.apply(conv1Output);
const conv2Output = conv2.apply(maxPool1Output);
const maxPool2Output = maxPool2.apply(conv2Output);
const flattenOutput = flatten.apply(maxPool2Output);
const dense1Output = dense1.apply(flattenOutput);
const dense2Output = dense2.apply(dense1Output);
const softMaxOutput = softmaxLayer.apply(dense2Output);

// For multiple outputs purpose, we use function tf.model API to build the model.
const model = tf.model({
    inputs: input,
    outputs: softMaxOutput
});</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    Because of the limitations of TensorFlow.js library, we have to use the traditional tf.model() and layer.apply() techniques to construct the model. All layer output objects will be used later for the multiple outputs of the encapsulated model.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    If you build the model by tf.sequential(), you probably want to check <a href="#toConvert">2. To convert an existing tfjs model to make it compatible with TensorSpace.</a>
                </li>
            </ul>
        </div>

        <div>After creating the model, we can load the data, compile the model and train it: (The training script is modified from tfjs's <a href="https://js.tensorflow.org/tutorials/mnist.html">official tutorial</a>)</div>
        <div class="code-snippet">
            <pre><code class="Javascript">const LEARNING_RATE = 0.0001;
const optimizer = tf.train.adam(LEARNING_RATE);

model.compile({
    optimizer: optimizer,
    loss: 'categoricalCrossentropy',
    metrics: ['accuracy'],
});

let data;
async function load() {
    data = new MnistData();
    await data.load();
}

async function train() {

    const BATCH_SIZE = 50;
    const TRAIN_BATCHES = 2;

    const TEST_BATCH_SIZE = 1000;
    const TEST_ITERATION_FREQUENCY = 100;

    for (let i = 0; i < TRAIN_BATCHES; i++) {
        const batch = data.nextTrainBatch(BATCH_SIZE);

        let testBatch;
        let validationData;

        if (i % TEST_ITERATION_FREQUENCY === 0) {
            testBatch = data.nextTestBatch(TEST_BATCH_SIZE);
            validationData = [
                testBatch.xs.reshape(
                    [TEST_BATCH_SIZE, 28, 28, 1]
                ),
                testBatch.labels
            ];
        }

        const history = await model.fit(
            batch.xs.reshape([BATCH_SIZE, 28, 28, 1]),
            batch.labels,
            {
                batchSize: BATCH_SIZE,
                validationData,
                epochs: 1
            });

        if (i % TEST_ITERATION_FREQUENCY === 0) {
            const loss = history.history.loss[0];
            const accuracy = history.history.acc[0];

            console.log(accuracy);
        }
    }
}

await load();
await train();</code></pre>
        </div>

        <div><span class="span_bold">1.2 Collect internal outputs from intermediate layers</span></div>
        <div>Since we construct the model by applying the output from the previous layer, we can encapsulate all or our desired layer outputs into a new model:</div>
        <div class="code-snippet">
            <pre><code class="Javascript">const encModel = tf.model({
    inputs: input,
    outputs: [conv1Output, maxPool1Output, conv2Output,
    maxPool2Output, dense1Output, dense2Output, softMaxOutput]
});</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    <span class="highlight-text">model</span> is the model which we train and evaluate following the common ML process.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    <span class="highlight-text">encModel</span> is the model with multiple intermediate outputs and will be saved later.
                </li>
            </ul>
        </div>

        <div><span class="span_bold">1.3 Save the encapsulated model</span></div>
        <div>Last, we can save our encapsulated model:</div>
        <div class="code-snippet">
            <pre><code class="Javascript">async function saveModel() {
    await encModel.save("downloads://YOUR_MODEL_NAME");
}</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    <span class="highlight-text">downloads://</span> means to download from the browser.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    There are two types of files created:
                    <ul class="list-indent">
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">.json</span> is for the model structure
                        </li>
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">.bin</span> is the trained weights
                        </li>
                    </ul>
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    Checkout <a href="https://js.tensorflow.org/api/0.13.0/#tf.Model.save">tf.Model.save</a> for more information.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    For other save method, please checkout the official <a href="https://js.tensorflow.org/tutorials/model-save-load.html">guide</a>
                </li>
            </ul>
        </div>

        <div>After downloading from the browser, we shall have the following files:</div>

        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_created_model.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 3</span> - Saved model files
        </div>

        <div id="toConvert" class="sub-title">2 To convert an existing tfjs model to make it compatible with TensorSpace</div>

        <div><span class="span_bold">2.1 Load an existing model</span></div>
        <div>To load an existing tfjs model, just simply load like:</div>
        <div class="code-snippet">
            <pre><code class="Javascript">const loadedModel = await tf.loadModel('/PATH_TO_MODEL_JSON/model.json');</code></pre>
        </div>

        <div><span class="span_bold">2.2 Collect internal outputs from intermediate layers</span></div>
        <div>All we want from the model is to collect the internal outputs from intermediate layers. We can collect the output from each desired layer:</div>

        <div class="code-snippet">
            <pre><code class="Javascript">// Hard code the input if you are sure about the shape
// const input = tf.input({shape: [28, 28, 1]});
const input = ((typeof loadedModel === 'undefined') ? layers[0].input : loadedModel.input);

let targetLayerNameList = ["MyConv2D_1","MyMaxPooling_1","MyConv2D_2","MyMaxPooling_2","MySoftMax"];
let outputList = [];
let tempInput = input;
let tempOutput = null;

for (i =0; i < layers.length; i++) {
    console.log("name: " + layers[i].name);
    tempOutput = layers[i].apply(tempInput);

    if (targetLayerNameList.indexOf(layers[i].name) >-1) {
        outputList.push(tempOutput);
    }
    tempInput = tempOutput;
}

console.log(outputList);</code></pre>
        </div>

        <div>The console output shall be:</div>
        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_console_output_1.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 4</span> - Intermediate layer names and multiple outputs
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    Because of the limitations of TensorFlow.js, we have to apply each layer to its corresponding input manually.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    In our example, since the model structure is simple: a single workflow from start to the end, we just need to iterate every layer and set the layer output as the input for the next layer. However, if you have a complex structure, please double check the inputs the layer required.
                </li>
            </ul>
        </div>

        <div>Then, we can encapsulate the desired outputs into a new model with the same input as the original model:</div>

        <div class="code-snippet">
            <pre><code class="Javascript">const encModel = tf.model({
    inputs: input,
    outputs: outputList
});

singleOutput = encModel.predict(tf.randomNormal([1,28,28,1]));
console.log(singleOutput);</code></pre>
        </div>

        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_console_output_2.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 5</span> - Multiple outputs from encapsulated model
        </div>

        <div><span class="span_bold">2.3 Save the encapsulated model</span></div>
        <div>After completing the previous steps, we can save the encapsulated model:</div>
        <div class="code-snippet">
            <pre><code class="Javascript">async function saveModel() {
    await encModel.save("downloads://encModel");
}
saveModel();</code></pre>
        </div>

        <div>
            If everything looks good, you shall be ready for the next step
            - <a href="basicLoad.html">Load a TensorSpace compatible model</a>
        </div>

    </main>
</div>

<footer>
    Copyright © 2018 TensorSpace.js. All rights reserved
</footer>

</body>

</html>
