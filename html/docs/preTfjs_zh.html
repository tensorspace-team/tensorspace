<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>模型预处理 - TensorFlow.js</title>

    <meta name="description" content="Documentation page of TensorSpace.js">
    <meta name="author" content="syt123450 / https://github.com/syt123450">
    <meta name="author" content="zchholmes / https://github.com/zchholmes">
    <link rel='icon' href='../../assets/img/common/logo.ico' type=‘image/x-ico’>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="../../assets/jslib/jquery.min.js"></script>
    <link rel="stylesheet" href="../../assets/csslib/bootstrap.min.css">
    <script src="../../assets/jslib/bootstrap.min.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/material.fonts.css">
    <link rel="stylesheet" href="../../assets/csslib/material.min.css">
    <script src="../../assets/jslib/material.min.js"></script>

    <script src="../../js/websiteUtil.js"></script>
    <script src="../../js/commonDoc.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/mono-blue.css">
    <script src="../../assets/jslib/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/commonDoc.css">
    <link rel="stylesheet" href="../../css/docsFont_zh.css">

</head>
<body>

<nav>

    <div class="container">

        <div id="logo">
            <a href="../../index_zh.html">
                <img src="../../assets/img/common/logoSmall.png">
                <div>TensorSpace.js</div>
            </a>
        </div>

        <ul class="hidden-xs">
            <li class="now"><a href="startIntro_zh.html">文档</a></li>
            <li><a href="../playground/index_zh.html">体验TensorSpace</a></li>
            <!-- <li><a href="../gallery_zh.html">应用展示</a></li> -->
            <li><a href="../../index_zh.html#download">下载</a></li>
            <!-- <li><a href="../developer_zh.html">参与开发</a></li> -->

            <a href="https://github.com/syt123450/Gio.js" class="github-corner" aria-label="View source on Github">
                <svg viewBox="0 0 250 250" aria-hidden="true">
                    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                          fill="currentColor" class="octo-body"></path>
                </svg>
            </a>

        </ul>

    </div>

    <ul id="more" class="nav nav-tabs visible-xs">
        <li>
            <a>
                <span class="glyphicon glyphicon-th-large"></span>
            </a>
        </li>
    </ul>

    <ul id="nav-collapse" class="nav navbar-nav">
        <li><a href="../../index_zh.html">主页</a></li>
        <li><a href="../../index_zh.html#download">下载</a></li>
        <!-- <li><a href="../developer_zh.html">参与开发</a></li> -->
    </ul>

    <div class="language">
        <div>
            <div><a href="preTfjs.html">EN</a></div>
        </div>
        <div class="selected">
            <div>中</div>
        </div>
    </div>

</nav>

<div id="smallGuide">
    <span class="glyphicon glyphicon-list"></span>
</div>

<div id="hideNav">

    <img id="ContentLogo" src="../../assets/img/docs/logo_white.png">

    <header>TensorSpace.js</header>

    <div>
        <div id="startLabelS">
            开始使用<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="startS">
            <li><a href="startIntro_zh.html">简介</a></li>
            <li><a href="startSystem_zh.html">环境要求</a></li>
            <li><a href="startInstall_zh.html">安装</a></li>
            <li><a href="startHello_zh.html">TensorSpace Hello World</a></li>
            <li><a href="startOther_zh.html">其他文档资源</a></li>
        </ul>
    </div>
    <div>
        <div id="basicLabelS">
            基本概念<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="basicS">
            <li><a href="basicIntro_zh.html">简介</a></li>
            <li><a href="basicModel_zh.html">模型</a></li>
            <li><a href="basicLayer_zh.html">网络层</a></li>
            <li><a href="basicPreprocessing_zh.html">预处理</a></li>
            <li><a href="basicLoad_zh.html">载入模型</a></li>
            <li><a href="basicPredict_zh.html">预测</a></li>
            <li><a href="basicClose_zh.html">网络层关闭按钮</a></li>
            <li><a href="basicPaging_zh.html">网络层分页</a></li>
            <li><a href="basicMetrics_zh.html">网络层系数</a></li>
            <li><a href="basicDimension_zh.html">网络层维度</a></li>
            <li><a href="basicColor_zh.html">网络层颜色</a></li>
            <li><a href="basicStats_zh.html">性能监控</a></li>
        </ul>
    </div>
    <div class="open initLabel">
        <div id="preprocessingLabelS">
            模型预处理<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="preprocessingS">
            <li><a href="preIntro_zh.html">简介</a></li>
            <li><a href="preTf_zh.html">TensorFlow</a></li>
            <li><a href="preKeras_zh.html">Keras</a></li>
            <li><a href="preTfKeras_zh.html">tf.keras</a></li>
            <li class="nowLabel">TensorFlow.js</li>
        </ul>
    </div>
    <div>
        <div id="modelLabelS">
            模型<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="modelS">
            <li><a href="modelIntro_zh.html">简介</a></li>
            <li><a href="modelFunctional_zh.html">函数式模型</a></li>
            <li><a href="modelSequential_zh.html">顺序模型</a></li>
        </ul>
    </div>
    <div>
        <div id="layerLabelS">
            网络层<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="layerS">
            <li><a href="layerIntro_zh.html">简介</a></li>
            <li><a href="layerConv1d_zh.html">Conv1d</a></li>
            <li><a href="layerConv2d_zh.html">Conv2d</a></li>
            <li><a href="layerTranspose_zh.html">Conv2dTranspose</a></li>
            <li><a href="layerCropping1d_zh.html">Cropping1d</a></li>
            <li><a href="layerCropping2d_zh.html">Cropping2d</a></li>
            <li><a href="layerDense_zh.html">Dense</a></li>
            <li><a href="layerFlatten_zh.html">Flatten</a></li>
            <li><a href="layerGlobalPooling1d_zh.html">GlobalPooling1d</a></li>
            <li><a href="layerGlobalPooling2d_zh.html">GlobalPooling2d</a></li>
            <li><a href="layerPadding1d_zh.html">Padding1d</a></li>
            <li><a href="layerPadding2d_zh.html">Padding2d</a></li>
            <li><a href="layerPooling1d_zh.html">Pooling1d</a></li>
            <li><a href="layerPooling2d_zh.html">Pooling2d</a></li>
            <li><a href="layerReshape_zh.html">Reshape</a></li>
            <li><a href="layerUpSampling1d_zh.html">UpSampling1d</a></li>
            <li><a href="layerUpSampling2d_zh.html">UpSampling2d</a></li>
            <li><a href="layerActivation1d_zh.html">Activation1d</a></li>
            <li><a href="layerActivation2d_zh.html">Activation2d</a></li>
            <li><a href="layerActivation3d_zh.html">Activation3d</a></li>
            <li><a href="layerLayer1d_zh.html">Layer1d</a></li>
            <li><a href="layerLayer2d_zh.html">Layer2d</a></li>
            <li><a href="layerLayer3d_zh.html">Layer3d</a></li>
            <li><a href="layerInput1d_zh.html">Input1d</a></li>
            <li><a href="layerInput2d_zh.html">Input2d</a></li>
            <li><a href="layerInput3d_zh.html">Input3d</a></li>
            <li><a href="layerOutput1d_zh.html">Output1d</a></li>
            <li><a href="layerOutputDetect_zh.html">OutputDetection</a></li>
            <li><a href="layerYoloGrid_zh.html">YoloGrid</a></li>
        </ul>
    </div>
    <div>
        <div id="mergeLabelS">
            网络层融合<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="mergeS">
            <li><a href="mergeIntro_zh.html">简介</a></li>
            <li><a href="mergeAdd_zh.html">Add</a></li>
            <li><a href="mergeSub_zh.html">Subtract</a></li>
            <li><a href="mergeMul_zh.html">Multiply</a></li>
            <li><a href="mergeMax_zh.html">Maximum</a></li>
            <li><a href="mergeAver_zh.html">Average</a></li>
            <li><a href="mergeConcate_zh.html">Concatenate</a></li>
        </ul>
    </div>

    <img id="close" src="../../assets/img/docs/close.png">

</div>

<div id="curtain"></div>

<div id="documentArea" class="container">

    <aside>
        <div>
            <div id="startLabel">
                开始使用<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="start">
                <li><a href="startIntro_zh.html">简介</a></li>
                <li><a href="startSystem_zh.html">环境要求</a></li>
                <li><a href="startInstall_zh.html">安装</a></li>
                <li><a href="startHello_zh.html">TensorSpace Hello World</a></li>
                <li><a href="startOther_zh.html">其他文档资源</a></li>
            </ul>
        </div>
        <div>
            <div id="basicLabel">
                基本概念<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="basic">
                <li><a href="basicIntro_zh.html">简介</a></li>
                <li><a href="basicModel_zh.html">模型</a></li>
                <li><a href="basicLayer_zh.html">网络层</a></li>
                <li><a href="basicPreprocessing_zh.html">预处理</a></li>
                <li><a href="basicLoad_zh.html">载入模型</a></li>
                <li><a href="basicPredict_zh.html">预测</a></li>
                <li><a href="basicClose_zh.html">网络层关闭按钮</a></li>
                <li><a href="basicPaging_zh.html">网络层分页</a></li>
                <li><a href="basicMetrics_zh.html">网络层系数</a></li>
                <li><a href="basicDimension_zh.html">网络层维度</a></li>
                <li><a href="basicColor_zh.html">网络层颜色</a></li>
                <li><a href="basicStats_zh.html">性能监控</a></li>
            </ul>
        </div>
        <div class="open initLabel">
            <div id="preprocessingLabel">
                模型预处理<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="preprocessing">
                <li><a href="preIntro_zh.html">简介</a></li>
                <li><a href="preTf_zh.html">TensorFlow</a></li>
                <li><a href="preKeras_zh.html">Keras</a></li>
                <li><a href="preTfKeras_zh.html">tf.keras</a></li>
                <li class="nowLabel">TensorFlow.js</li>
            </ul>
        </div>
        <div>
            <div id="modelLabel">
                模型<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="model">
                <li><a href="modelIntro_zh.html">简介</a></li>
                <li><a href="modelFunctional_zh.html">函数式模型</a></li>
                <li><a href="modelSequential_zh.html">顺序模型</a></li>
            </ul>
        </div>
        <div>
            <div id="layerLabel">
                网络层<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="layer">
                <li><a href="layerIntro_zh.html">简介</a></li>
                <li><a href="layerConv1d_zh.html">Conv1d</a></li>
                <li><a href="layerConv2d_zh.html">Conv2d</a></li>
                <li><a href="layerTranspose_zh.html">Conv2dTranspose</a></li>
                <li><a href="layerCropping1d_zh.html">Cropping1d</a></li>
                <li><a href="layerCropping2d_zh.html">Cropping2d</a></li>
                <li><a href="layerDense_zh.html">Dense</a></li>
                <li><a href="layerFlatten_zh.html">Flatten</a></li>
                <li><a href="layerGlobalPooling1d_zh.html">GlobalPooling1d</a></li>
                <li><a href="layerGlobalPooling2d_zh.html">GlobalPooling2d</a></li>
                <li><a href="layerPadding1d_zh.html">Padding1d</a></li>
                <li><a href="layerPadding2d_zh.html">Padding2d</a></li>
                <li><a href="layerPooling1d_zh.html">Pooling1d</a></li>
                <li><a href="layerPooling2d_zh.html">Pooling2d</a></li>
                <li><a href="layerReshape_zh.html">Reshape</a></li>
                <li><a href="layerUpSampling1d_zh.html">UpSampling1d</a></li>
                <li><a href="layerUpSampling2d_zh.html">UpSampling2d</a></li>
                <li><a href="layerActivation1d_zh.html">Activation1d</a></li>
                <li><a href="layerActivation2d_zh.html">Activation2d</a></li>
                <li><a href="layerActivation3d_zh.html">Activation3d</a></li>
                <li><a href="layerLayer1d_zh.html">Layer1d</a></li>
                <li><a href="layerLayer2d_zh.html">Layer2d</a></li>
                <li><a href="layerLayer3d_zh.html">Layer3d</a></li>
                <li><a href="layerInput1d_zh.html">Input1d</a></li>
                <li><a href="layerInput2d_zh.html">Input2d</a></li>
                <li><a href="layerInput3d_zh.html">Input3d</a></li>
                <li><a href="layerOutput1d_zh.html">Output1d</a></li>
                <li><a href="layerOutputDetect_zh.html">OutputDetection</a></li>
                <li><a href="layerYoloGrid_zh.html">YoloGrid</a></li>
            </ul>
        </div>
        <div>
            <div id="mergeLabel">
                网络层融合<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="merge">
                <li><a href="mergeIntro_zh.html">简介</a></li>
                <li><a href="mergeAdd_zh.html">Add</a></li>
                <li><a href="mergeSub_zh.html">Subtract</a></li>
                <li><a href="mergeMul_zh.html">Multiply</a></li>
                <li><a href="mergeMax_zh.html">Maximum</a></li>
                <li><a href="mergeAver_zh.html">Average</a></li>
                <li><a href="mergeConcate_zh.html">Concatenate</a></li>
            </ul>
        </div>
    </aside>

    <main>

        <img class="logo-img" src="../../assets/img/docs/Logos/tfjs.png">

        <header>预处理TensorFlow.js模型</header>

        <div>本篇将介绍如何预处理基于 TensorFlow.js （以下简写为 “tfjs” ）构建的网络模型以适配 TensorSpace。</div>

        <div>如果您是第一次使用 tfjs 的新手，建议先阅读由 TensorFlow.js 官方提供的网络训练<a href="https://js.tensorflow.org/tutorials/">教程</a>。</div>

        <div>以下为本篇教程所使用的代码及模型文件：</div>

        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess_zh/TensorFlowJS/src_html/createTfjsModel.html">
                createTfjsModel.html
            </a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess_zh/TensorFlowJS/src_html/loadTfjsModel.html">
                loadTfjsModel.html
            </a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/tree/master/docs/preprocess_zh/TensorFlowjs/models">
                模型
            </a>
        </div>
        <div>请确保正确安装并引入 tfjs。</div>
        <div>安装 tfjs：</div>
        <div class="code-snippet">
            <pre><code class="Bash">
npm install @tensorflow/tfjs</code></pre>
        </div>
        <div>通过以下脚本在 html 中引入 tfjs：</div>
        <div class="code-snippet">
            <pre><code class="html">
&lt;script src="libs/tf.min.js"&gt;&lt;/script&gt;</code></pre>
        </div>
        <div>预处理 tfjs 模型，有以下几个步骤：</div>
        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_general_process_zh.png">
        <div class="img-label">
            <span class="img-label-number">图1</span> - 预处理 tfjs 模型的步骤
        </div>
        <div>本教程中，我们将分两种主要情况来介绍预处理的过程：</div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#toTrain">1. 训练一个 TensorSpace 适配的模型l</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#toConvert">2. 转换一个 tfjs 模型以适配 TensorSpace</a>
        </div>
        <div>以下均使用 MNIST 数据集以及 LeNet 网络结构为例。</div>

        <div id="toTrain" class="sub-title">1 训练 TensorSpace 适配的模型</div>

        <div><span class="span_bold">1.1 训练新模型</span></div>

        <div>若果您并没有任何可以直接使用的 tfjs 模型，可以按照本小节的方法构筑一个新的样例模型。</div>

        <div>首先，让我们了解以下 LeNet 的网络结构：</div>

        <img class="tag-img" src="../../assets/img/docs/General/intro_preprocess_s_zh.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 2</span> - LeNet structure
        </div>
        <div>根据以上结构，搭建一个基本的网络。</div>

        <div>〔源码〕<a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/createTfjsModel.html#L14">createTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">// Initialize layer.
const input = tf.input({shape: [28, 28, 1]});
const conv1 = tf.layers.conv2d({
    kernelSize: 5,
    filters: 6,
    strides: 1,
    activation: 'relu',
    kernelInitializer: 'VarianceScaling',
    name: 'MyConv2D_1'
});
const maxPool1 = tf.layers.maxPooling2d({
    poolSize: [2, 2],
    strides: [2, 2],
    name: 'MyMaxPooling_1'
});
const conv2 = tf.layers.conv2d({
    kernelSize: 5,
    filters: 16,
    strides: 1,
    activation: 'relu',
    kernelInitializer: 'VarianceScaling',
    name: 'MyConv2D_2'
});
const maxPool2 = tf.layers.maxPooling2d({
    poolSize: [2, 2],
    strides: [2, 2],
    name: 'MyMaxPooling_2'
});

const flatten = tf.layers.flatten();

const dense1 = tf.layers.dense({
    units: 120,
    kernelInitializer: 'VarianceScaling',
    activation: 'relu',
    name: 'MyDense_1'
});
const dense2 = tf.layers.dense({
    units: 84,
    kernelInitializer: 'VarianceScaling',
    activation: 'relu',
    name: 'MyDense_2'
});
const softmaxLayer = tf.layers.dense({
    units: 10,
    kernelInitializer: 'VarianceScaling',
    activation: 'softmax',
    name: 'MySoftMax'
});

// Make layer connection.
const conv1Output = conv1.apply(input);
const maxPool1Output = maxPool1.apply(conv1Output);
const conv2Output = conv2.apply(maxPool1Output);
const maxPool2Output = maxPool2.apply(conv2Output);
const flattenOutput = flatten.apply(maxPool2Output);
const dense1Output = dense1.apply(flattenOutput);
const dense2Output = dense2.apply(dense1Output);
const softMaxOutput = softmaxLayer.apply(dense2Output);

// For multiple outputs purpose, we use function tf.model API to build the model.
const model = tf.model({
    inputs: input,
    outputs: softMaxOutput
});</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>注意：</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    由于 tfjs 的限制，需要使用 <span class="highlight-text">tf.model()</span> 和 <span class="highlight-text">layer.apply()</span> 的组合来构建网络。所有的输出对象将在之后保存到嵌入后模型中。
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    如果您需要使用 <span class="highlight-text">tf.sequential()</span> 来构建网络，那么您需要参见 <a href="#toConvert">2. 转换一个 tfjs 模型以适配 TensorSpace</a>.
                </li>
            </ul>
        </div>

        <div>在构建网络结构之后，载入 MNIST 数据集进行编译和训练： （注：训练用脚本来源自 tfjs <a href="https://js.tensorflow.org/tutorials/mnist.html">官方教程</a>）</div>

        <div>〔源码〕<a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/createTfjsModel.html#L88">createTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">const LEARNING_RATE = 0.0001;
const optimizer = tf.train.adam(LEARNING_RATE);

model.compile({
    optimizer: optimizer,
    loss: 'categoricalCrossentropy',
    metrics: ['accuracy'],
});

let data;
async function load() {
    data = new MnistData();
    await data.load();
}

async function train() {

    const BATCH_SIZE = 50;
    const TRAIN_BATCHES = 2;

    const TEST_BATCH_SIZE = 1000;
    const TEST_ITERATION_FREQUENCY = 100;

    for (let i = 0; i < TRAIN_BATCHES; i++) {
        const batch = data.nextTrainBatch(BATCH_SIZE);

        let testBatch;
        let validationData;

        if (i % TEST_ITERATION_FREQUENCY === 0) {
            testBatch = data.nextTestBatch(TEST_BATCH_SIZE);
            validationData = [
                testBatch.xs.reshape(
                    [TEST_BATCH_SIZE, 28, 28, 1]
                ),
                testBatch.labels
            ];
        }

        const history = await model.fit(
            batch.xs.reshape([BATCH_SIZE, 28, 28, 1]),
            batch.labels,
            {
                batchSize: BATCH_SIZE,
                validationData,
                epochs: 1
            });

        if (i % TEST_ITERATION_FREQUENCY === 0) {
            const loss = history.history.loss[0];
            const accuracy = history.history.acc[0];

            console.log(accuracy);
        }
    }
}

await load();
await train();</code></pre>
        </div>

        <div><span class="span_bold">1.2 收集中间层数据</span></div>
        <div>在构建时由于采用了将前一层输出用作下一层输入的方法，我们只要将所需要的中间层包裹并植入一个新的模型之中即可。</div>

        <div>〔源码〕<a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/createTfjsModel.html#L77">createTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">const encModel = tf.model({
    inputs: input,
    outputs: [conv1Output, maxPool1Output, conv2Output,
    maxPool2Output, dense1Output, dense2Output, softMaxOutput]
});</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>注意：</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    实际上创建了两个模型：
                    <ul class="list-indent">
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">model</span> 是我们按照常规机器学习流程创建的模型。
                        </li>
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">encModel</span> 是我们添加了中间层输出的<span class="highlight-text">嵌入多输出模型</span>，稍后进行保存。
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <div><span class="span_bold">1.3 保存嵌入后模型</span></div>
        <div>以下代码用于保存嵌入的多输出模型。〔源码〕<a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/createTfjsModel.html#L143">createTfjsModel.html</a></div>
        <div class="code-snippet">
            <pre><code class="Javascript">async function saveModel() {
    await encModel.save("downloads://YOUR_MODEL_NAME");
}</code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>注意：</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    <span class="highlight-text">downloads://</span> 表示<span class="span_bold">通过浏览器下载</span>将模型保存到本地。
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    我们将会得到2种不同类型的文件：
                    <ul class="list-indent">
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">.json</span> 包含神经网络结构。
                        </li>
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            <span class="highlight-text">.bin</span> 包含所训练得到的权重。
                        </li>
                    </ul>
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    关于保存 tfjs 模型，参考 <a href="https://js.tensorflow.org/api/0.13.0/#tf.Model.save">tf.Model.save</a>。
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    关于其他保存模型的方式，参考 <a href="https://js.tensorflow.org/tutorials/model-save-load.html">官方保存教程</a>
                </li>
            </ul>
        </div>

        <div>在保存文件之后，可以得到：</div>

        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_created_model.png">
        <div class="img-label">
            <span class="img-label-number">图3</span> - 转换后所保存的最终模型文件
        </div>

        <div id="toConvert" class="sub-title">2 转换 tfjs 模型以适配 TensorSpace</div>

        <div><span class="span_bold">2.1 载入现有模型</span></div>
        <div>通过以下代码加载 tfjs 模型。</div>
        <div>〔源码〕 <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/loadTfjsModel.html#L19">loadTfjsModel.html</a></div>
        <div class="code-snippet">
            <pre><code class="Javascript">const loadedModel = await tf.loadModel('/PATH_TO_MODEL_JSON/model.json');</code></pre>
        </div>

        <div><span class="span_bold">2.2 收集中间层数据</span></div>

        <div>通过以下方式收集中间层数据。〔源码〕 <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/loadTfjsModel.html#L23">loadTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">// Hard code the input if you are sure about the shape
// const input = tf.input({shape: [28, 28, 1]});
const input = ((typeof loadedModel === 'undefined') ? layers[0].input : loadedModel.input);

let targetLayerNameList = ["MyConv2D_1","MyMaxPooling_1","MyConv2D_2","MyMaxPooling_2","MySoftMax"];
let outputList = [];
let tempInput = input;
let tempOutput = null;

for (i =0; i < layers.length; i++) {
    console.log("name: " + layers[i].name);
    tempOutput = layers[i].apply(tempInput);

    if (targetLayerNameList.indexOf(layers[i].name) >-1) {
        outputList.push(tempOutput);
    }
    tempInput = tempOutput;
}

console.log(outputList);</code></pre>
        </div>

        <div>浏览器控制台有以下输出：</div>
        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_console_output_1.png">
        <div class="img-label">
            <span class="img-label-number">图4</span> - 多中间层名称及输出
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>注意：</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    由于 tfjs 的局限性，需要为中间层逐一添加所对应的输入。
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    在例子中，由于模型结构比较简单。只需要<span class="span_bold">逐一遍历每一层对象</span>，将其作为下一层的输入提供给下一层的对象。但当我们在遇到比较复杂的模型结构时，请根据实际情况调整合适的输入输出方法。                </li>
            </ul>
        </div>

        <div>之后，将提取到的层对象添加到一个新的模型即可。</div>

        <div>〔源码〕 <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/loadTfjsModel.html#L36">loadTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">const encModel = tf.model({
    inputs: input,
    outputs: outputList
});

singleOutput = encModel.predict(tf.randomNormal([1,28,28,1]));
console.log(singleOutput);</code></pre>
        </div>

        <img class="tag-img" src="../../assets/img/docs/TensorFlowJS/tfjs_console_output_2.png">
        <div class="img-label">
            <span class="img-label-number">图5</span> - 嵌入后模型的中间层输出
        </div>

        <div><span class="span_bold">2.3 保存嵌入的多输出模型</span></div>
        <div>完成上述步骤之后，使用下面代码保存多输出模型。</div>

        <div>〔源码〕 <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/TensorFlowJS/src_html/loadTfjsModel.html#L13">loadTfjsModel.html</a></div>

        <div class="code-snippet">
            <pre><code class="Javascript">async function saveModel() {
    await encModel.save("downloads://encModel");
}
saveModel();</code></pre>
        </div>

        <div>
            若至此一切顺利，可移步下一部分——
            <a href="basicLoad_zh.html">加载TensorSpace适配模型</a>
        </div>

    </main>
</div>

<footer>
    Copyright © 2018 TensorSpace.js. All rights reserved
</footer>

</body>

</html>
