<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Proprecessing - Keras</title>

    <meta name="description" content="Documentation page of TensorSpace.js">
    <meta name="author" content="syt123450 / https://github.com/syt123450">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="../../assets/jslib/jquery.min.js"></script>
    <link rel="stylesheet" href="../../assets/csslib/bootstrap.min.css">
    <script src="../../assets/jslib/bootstrap.min.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/material.fonts.css">
    <link rel="stylesheet" href="../../assets/csslib/material.min.css">
    <script src="../../assets/jslib/material.min.js"></script>

    <script src="../../js/websiteUtil.js"></script>
    <script src="../../js/commonDoc.js"></script>

    <link rel="stylesheet" href="../../assets/csslib/mono-blue.css">
    <script src="../../assets/jslib/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/commonDoc.css">
    <link rel="stylesheet" href="../../css/docsFont.css">

</head>
<body>

<nav>

    <div class="container">

        <div id="logo">
            <a href="../../index.html">
                <img src="../../assets/img/common/logoSmall.png">
                <div>TensorSpace.js</div>
            </a>
        </div>

        <ul class="hidden-xs">
            <li class="now"><a href="index.html">Documentation</a></li>
            <li><a href="../playground/index.html">Playground</a></li>
            <li><a href="../gallery.html">Gallery</a></li>
            <li><a href="../../index.html#download">Download</a></li>
            <li><a href="../developer.html">Developer</a></li>

            <a href="https://github.com/syt123450/Gio.js" class="github-corner" aria-label="View source on Github">
                <svg viewBox="0 0 250 250" aria-hidden="true">
                    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6
                    C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9
                    134.4,103.2"
                          fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4
                    142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4
                    163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4
                    C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0
                    205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1
                    C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                          fill="currentColor" class="octo-body"></path>
                </svg>
            </a>

        </ul>

    </div>

    <ul id="more" class="nav nav-tabs visible-xs">
        <li>
            <a>
                <span class="glyphicon glyphicon-th-large"></span>
            </a>
        </li>
    </ul>

    <ul id="nav-collapse" class="nav navbar-nav">
        <li><a href="../../index.html">Home</a></li>
        <li><a href="../../index.html#download">Download</a></li>
        <li><a href="../developer.html">Developer</a></li>
    </ul>

    <div class="language">
        <div class="selected">
            <div>EN</div>
        </div>
        <div>
            <div><a href="preKeras_zh.html">中</a></div>
        </div>
    </div>

</nav>

<div id="smallGuide">
    <span class="glyphicon glyphicon-list"></span>
</div>

<div id="hideNav">

    <img id="ContentLogo" src="../../assets/images/logo_white.png">

    <header>TensorSpace.js</header>

    <div>
        <div id="startLabelS">
            Getting Start<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="startS">
            <li><a href="startIntro.html">Introduce</a></li>
            <li><a href="startSystem.html">System Requirements</a></li>
            <li><a href="startInstall.html">Installation</a></li>
            <li><a href="startHello.html">TensorSpace Hello World</a></li>
            <li><a href="startOther.html">More Resources</a></li>
        </ul>
    </div>
    <div>
        <div id="basicLabelS">
            Basic Concepts<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="basicS">
            <li><a href="basicIntro.html">Introduce</a></li>
            <li><a href="basicModel.html">Model</a></li>
            <li><a href="basicLayer.html">Layer</a></li>
            <li><a href="basicPreprocessing.html">Preprocessing</a></li>
            <li><a href="basicLoad.html">Load Model</a></li>
            <li><a href="basicPredict.html">Predict</a></li>
            <li><a href="basicClose.html">Close Button</a></li>
            <li><a href="basicPaging.html">Paging</a></li>
            <li><a href="basicMetrics.html">Layer Metrics</a></li>
            <li><a href="basicDimension.html">Layer Dimension</a></li>
            <li><a href="basicColor.html">Layer Color</a></li>
            <li><a href="basicStats.html">Stats</a></li>
        </ul>
    </div>
    <div class="open initLabel">
        <div id="preprocessingLabelS">
            Model Preprocessing<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="preprocessingS">
            <li><a href="preIntro.html">Introduce</a></li>
            <li><a href="preTf.html">TensorFlow</a></li>
            <li class="nowLabel">Keras</li>
            <li><a href="preTfKeras.html">tf.Keras</a></li>
            <li><a href="preTfjs.html">TensorFlow.js</a></li>
        </ul>
    </div>
    <div>
        <div id="modelLabelS">
            Models<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="modelS">
            <li><a href="modelIntro.html">Introduce</a></li>
            <li><a href="modelFunctional.html">Function Model</a></li>
            <li><a href="modelSequential.html">Sequential Model</a></li>
        </ul>
    </div>
    <div>
        <div id="layerLabelS">
            Layers<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="layerS">
            <li><a href="layerIntro.html">Introduce</a></li>
            <li><a href="layerConv1d.html">Conv1d</a></li>
            <li><a href="layerConv2d.html">Conv2d</a></li>
            <li><a href="layerTranspose.html">Conv2dTranspose</a></li>
            <li><a href="layerCropping1d.html">Cropping1d</a></li>
            <li><a href="layerCropping2d.html">Cropping2d</a></li>
            <li><a href="layerDense.html">Dense</a></li>
            <li><a href="layerFlatten.html">Flatten</a></li>
            <li><a href="layerGlobalPooling1d.html">GlobalPooling1d</a></li>
            <li><a href="layerGlobalPooling2d.html">GlobalPooling2d</a></li>
            <li><a href="layerPadding1d.html">Padding1d</a></li>
            <li><a href="layerPadding2d.html">Padding2d</a></li>
            <li><a href="layerPooling1d.html">Pooling1d</a></li>
            <li><a href="layerPooling2d.html">Pooling2d</a></li>
            <li><a href="layerReshape.html">Reshape</a></li>
            <li><a href="layerUpSampling1d.html">UpSampling1d</a></li>
            <li><a href="layerUpSampling2d.html">UpSampling2d</a></li>
            <li><a href="layerActivation1d.html">Activation1d</a></li>
            <li><a href="layerActivation2d.html">Activation2d</a></li>
            <li><a href="layerActivation3d.html">Activation3d</a></li>
            <li><a href="layerLayer1d.html">Layer1d</a></li>
            <li><a href="layerLayer2d.html">Layer2d</a></li>
            <li><a href="layerLayer3d.html">Layer3d</a></li>
            <li><a href="layerInput1d.html">Input1d</a></li>
            <li><a href="layerInput2d.html">Input2d</a></li>
            <li><a href="layerInput3d.html">Input3d</a></li>
            <li><a href="layerOutput1d.html">Output1d</a></li>
            <li><a href="layerOutputDetect.html">OutputDetection</a></li>
            <li><a href="layerYoloGrid.html">YoloGrid</a></li>
        </ul>
    </div>
    <div>
        <div id="mergeLabelS">
            Merge Function<img src="../../assets/img/docs/document_arrow.png">
        </div>
        <ul id="mergeS">
            <li><a href="mergeIntro.html">Introduce</a></li>
            <li><a href="mergeAdd.html">Add</a></li>
            <li><a href="mergeSub.html">Subtract</a></li>
            <li><a href="mergeMul.html">Multiply</a></li>
            <li><a href="mergeMax.html">Maximum</a></li>
            <li><a href="mergeAver.html">Average</a></li>
            <li><a href="mergeConcate.html">Concatenate</a></li>
        </ul>
    </div>

    <img id="close" src="../../assets/img/docs/close.png">

</div>

<div id="curtain"></div>

<div id="documentArea" class="container">

    <aside>
        <div>
            <div id="startLabel">
                Getting Start<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="start">
                <li><a href="startIntro.html">Introduce</a></li>
                <li><a href="startSystem.html">System Requirements</a></li>
                <li><a href="startInstall.html">Installation</a></li>
                <li><a href="startHello.html">TensorSpace Hello World</a></li>
                <li><a href="startOther.html">More Resources</a></li>
            </ul>
        </div>
        <div>
            <div id="basicLabel">
                Basic Concepts<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="basic">
                <li><a href="basicIntro.html">Introduce</a></li>
                <li><a href="basicModel.html">Model</a></li>
                <li><a href="basicLayer.html">Layer</a></li>
                <li><a href="basicPreprocessing.html">Preprocessing</a></li>
                <li><a href="basicLoad.html">Load Model</a></li>
                <li><a href="basicPredict.html">Predict</a></li>
                <li><a href="basicClose.html">Close Button</a></li>
                <li><a href="basicPaging.html">Paging</a></li>
                <li><a href="basicMetrics.html">Layer Metrics</a></li>
                <li><a href="basicDimension.html">Layer Dimension</a></li>
                <li><a href="basicColor.html">Layer Color</a></li>
                <li><a href="basicStats.html">Stats</a></li>
            </ul>
        </div>
        <div class="open initLabel">
            <div id="preprocessingLabel">
                Model Preprocessing<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="preprocessing">
                <li><a href="preIntro.html">Introduce</a></li>
                <li><a href="preTf.html">TensorFlow</a></li>
                <li class="nowLabel">Keras</li>
                <li><a href="preTfKeras.html">tf.Keras</a></li>
                <li><a href="preTfjs.html">TensorFlow.js</a></li>
            </ul>
        </div>
        <div>
            <div id="modelLabel">
                Models<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="model">
                <li><a href="modelIntro.html">Introduce</a></li>
                <li><a href="modelFunctional.html">Function Model</a></li>
                <li><a href="modelSequential.html">Sequential Model</a></li>
            </ul>
        </div>
        <div>
            <div id="layerLabel">
                Layers<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="layer">
                <li><a href="layerIntro.html">Introduce</a></li>
                <li><a href="layerConv1d.html">Conv1d</a></li>
                <li><a href="layerConv2d.html">Conv2d</a></li>
                <li><a href="layerTranspose.html">Conv2dTranspose</a></li>
                <li><a href="layerCropping1d.html">Cropping1d</a></li>
                <li><a href="layerCropping2d.html">Cropping2d</a></li>
                <li><a href="layerDense.html">Dense</a></li>
                <li><a href="layerFlatten.html">Flatten</a></li>
                <li><a href="layerGlobalPooling1d.html">GlobalPooling1d</a></li>
                <li><a href="layerGlobalPooling2d.html">GlobalPooling2d</a></li>
                <li><a href="layerPadding1d.html">Padding1d</a></li>
                <li><a href="layerPadding2d.html">Padding2d</a></li>
                <li><a href="layerPooling1d.html">Pooling1d</a></li>
                <li><a href="layerPooling2d.html">Pooling2d</a></li>
                <li><a href="layerReshape.html">Reshape</a></li>
                <li><a href="layerUpSampling1d.html">UpSampling1d</a></li>
                <li><a href="layerUpSampling2d.html">UpSampling2d</a></li>
                <li><a href="layerActivation1d.html">Activation1d</a></li>
                <li><a href="layerActivation2d.html">Activation2d</a></li>
                <li><a href="layerActivation3d.html">Activation3d</a></li>
                <li><a href="layerLayer1d.html">Layer1d</a></li>
                <li><a href="layerLayer2d.html">Layer2d</a></li>
                <li><a href="layerLayer3d.html">Layer3d</a></li>
                <li><a href="layerInput1d.html">Input1d</a></li>
                <li><a href="layerInput2d.html">Input2d</a></li>
                <li><a href="layerInput3d.html">Input3d</a></li>
                <li><a href="layerOutput1d.html">Output1d</a></li>
                <li><a href="layerOutputDetect.html">OutputDetection</a></li>
                <li><a href="layerYoloGrid.html">YoloGrid</a></li>
            </ul>
        </div>
        <div>
            <div id="mergeLabel">
                Merge Function<img src="../../assets/img/docs/document_arrow.png">
            </div>
            <ul id="merge">
                <li><a href="mergeIntro.html">Introduce</a></li>
                <li><a href="mergeAdd.html">Add</a></li>
                <li><a href="mergeSub.html">Subtract</a></li>
                <li><a href="mergeMul.html">Multiply</a></li>
                <li><a href="mergeMax.html">Maximum</a></li>
                <li><a href="mergeAver.html">Average</a></li>
                <li><a href="mergeConcate.html">Concatenate</a></li>
            </ul>
        </div>
    </aside>

    <main>
        <p align="center">
            <img class="logo-img" src="../../assets/img/docs/Logos/keras.png">
        </p>
        <header>Preprocessing Keras Model</header>

        <div>
            In this chapter, we will introduce how to preprocess a Keras model to adapt the multiple intermediate
            layer outputs for applying TensorSpace. If you have read the
            <a href="preTfKeras.html">tf.keras preprocessing tutorial</a>
            , since the close relations between the two APIs, the workflows are very similar.
        </div>

        <div>The sample files that are used for the tutorial are listed below:</div>

        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/Keras/src_py/keras_model.py">keras_model.py</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/blob/master/docs/preprocess/Keras/src_sh/convert_keras.sh">convert_keras.sh</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="https://github.com/syt123450/tensorspace/tree/master/docs/preprocess/Keras/models">all model files</a>
        </div>

        <div>For the tutorial, we use Python 3.6.5 and the following libraries:</div>

        <div class="code-snippet">
            <pre><code class="Python">
import tensorflow as tf
import numpy as np
from keras.models import Sequential, Model
from keras.layers import Dense, Input, InputLayer, Conv2D, MaxPooling2D, Reshape, Flatten
from keras.models import load_model
            </code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            The core libraries
            are <span class="highlight-text">keras</span> and <span class="highlight-text">numpy</span>.
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <span class="highlight-text">tf.keras</span> is used to provide dataset only.
        </div>

        <div>It is also required to install <a href="https://github.com/tensorflow/tfjs-converter">tfjs-converter</a> (a
            useful tool from TensorFlow.js):
        </div>

        <div class="code-snippet">
            <pre><code class="Bash">
$ pip install tensorflowjs
            </code></pre>
        </div>

        <div>
            If you are new on training a ML model by Keras, we highly recommand you to read the
            <a href="https://keras.io/#getting-started-30-seconds-to-keras">guide</a> from
            <a href="https://keras.io/">Keras</a> first.
        </div>

        <div>To preprocess a Keras model, we have the following steps:</div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_general_process.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 1</span> - Steps to preprocess a Keras model
        </div>

        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#loadModel">1. Train/Load model</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#addOutputs">2. Insert multiple intermediate outputs</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#saveModel">3. Save encapsulated model</a>
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            <a href="#convertModel">4. Convert to TensorSpace compatible model</a>
        </div>

        <div>In the tutorial, we try to preprocess a Keras model of LeNet with MNIST dataset as an example.</div>

        <div class="sub-title" id="loadModel">1 Train/Load Model</div>
        <div><span class="span_bold">1.1 Train a new model</span></div>

        <div>
            If you don't have your model trained yet or not sure how to generate a proper model for TensorSpace from a
            scratch, let's train a model together~
        </div>

        <div>By following the structure of the LeNet,</div>

        <img class="tag-img-vertical" src="../../assets/img/docs/General/LeNet_Structure.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 2</span> - LeNet structure
        </div>

        <div>We can generate a LeNet model as the following:</div>

        <div class="code-snippet">
            <pre><code class="python">
def create_sequential_model():
    single_output_model = Sequential([
        InputLayer(input_shape=(28, 28)),
        Reshape((28,28,1),input_shape=(28,28,)),
        Conv2D(filters=6, kernel_size=5, strides=1, input_shape=(28, 28, 1), name="Conv2D_1"),
        MaxPooling2D(pool_size=(2, 2), strides=(2, 2), name="MaxPooling2D_1"),
        Conv2D(filters=16, kernel_size=5, strides=1, name="Conv2D_2"),
        MaxPooling2D(pool_size=(2, 2), strides=(2, 2), name="MaxPooling2D_2"),
        Flatten(),
        Dense(120, activation="relu", name="Dense_1"),
        Dense(84, activation="relu", name="Dense_2"),
        Dense(10, activation="softmax", name="Softmax")
    ])
    return single_output_model
            </code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    We add the '<span class="span_bold highlight-text">name</span>' property for each layers
                    that we want to apply TensorSpace.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    The <a href="https://keras.io/#getting-started-30-seconds-to-keras">Guide</a>
                    from Keras can help you learn how to use the Keras library for more details.
                </li>
            </ul>
        </div>

        <div>After constructing the model structure, we compile and train it with the MNIST dataset.</div>

        <div class="code-snippet">
            <pre><code class="python">
(x_train, y_train), (x_test, y_test) = mnist.load_data()
x_train, x_test = x_train / 255.0, x_test / 255.0

model.compile(optimizer='adam',
              loss='sparse_categorical_crossentropy',
              metrics=['accuracy'])

model.fit(x_train, y_train, epochs=5, batch_size=32)
            </code></pre>
        </div>

        <div>
            After training, we should have a <span class="highlight-text">model</span> which contains the structure
            and weights of the network.
        </div>

        <div>We can try to predict a result from a random generated input:</div>

        <div class="code-snippet">
            <pre><code class="python">
input_sample = np.ndarray(shape=(28,28), buffer=np.random.rand(28,28))
input_sample = np.expand_dims(input_sample, axis=0)
print(model.predict(input_sample))
            </code></pre>
        </div>

        <div>And then we get the probabilities predicted by the model.</div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_predict_1.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 3</span> - Single list prediction output from trained model
        </div>

        <div><span class="span_bold">1.2 Load an existed model</span></div>

        <div>If you have already had a model in hand, let's load the model:</div>

        <div class="code-snippet">
            <pre><code class="python">
model = load_model("/PATH_TO_Keras/model.h5")
            </code></pre>
        </div>

        <div>Or if the model and weights are stored separately, we can load like:</div>

        <div class="code-snippet">
            <pre><code class="python">
json_path = "PATH_TO_JSON/model.json"
weight_path = "PATH_TO_WEIGHT/weights.hdf5"
structure = open(json_path, "r")
model = model_from_json(
    structure
    )
model.load_weights(weight_path)
            </code></pre>
        </div>

        <div>
            Similar to training a new model, after loading, we should have a <span class="highlight-text">model</span>
            which contains the structure and weights of the network.
            We can try to predict a result from a random generated input:
        </div>

        <div class="code-snippet">
            <pre><code class="python">
input_sample = np.ndarray(shape=(28,28), buffer=np.random.rand(28,28))
input_sample = np.expand_dims(input_sample, axis=0)
print(model.predict(input_sample))
            </code></pre>
        </div>

        <div>And then we get the probabilities predicted by the model.</div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_predict_1.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 4</span> - Single list prediction output from loaded model
        </div>

        <div class="sub-title" id="addOutputs">2 Insert multiple intermediate outputs</div>
        <div>
            We can observe that the output from predicting an input is a single list (softmax result). Each value of
            the list represents the probability of the corresponding digit that the input image could be.
        </div>

        <div>
            Since TensorSpace presents the relations among different layers, which show the outputs from intermediate
            layers, we need to collect necessary output data for TensorSpace to "draw" on the visualization model.
        </div>

        <div>
            First, we can use the <span class="highlight-text">summary()</span> function to check
            the layer information. We can also loop all layer names.
        </div>

        <div class="code-snippet">
            <pre><code class="python">
model.summary()
for layer in model.layers:
     print(layer.name)
            </code></pre>
        </div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_summary.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 5</span> - Model summary and layer names
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            If a <span class="span_bold highlight-text">name</span> property is set for a layer,
            we can see the name from <span class="highlight-text">summary()</span>.
        </div>
        <div class="panel-heading">
            <i class="material-icons material-icons--outline">filter_center_focus</i>
            If a model is loaded from an existed model, the layer name is related to the class names in most cases.
        </div>

        <div>Based on the summary, we can learn the general structure of a LeNet:</div>

        <div>
            It has two combinations of Conv2D and MaxPooling. Then after a flatten layer, it has three dense layers.
            All layers names are listed.
        </div>

        <div>
            Let's pick up the layers we want to present by TensorSpace and encapsulate a new model with the desired
            outputs:
        </div>
        <div class="code-snippet">
            <pre><code class="python">
output_layer_names = [
    "Conv2D_1", "MaxPooling2D_1", "Conv2D_2", "MaxPooling2D_2",
    "Dense_1", "Dense_2", "Softmax"
]
def generate_encapsulate_model_with_output_layer_names(model, output_layer_names):
    enc_model = Model(
        inputs=model.input,
        outputs=list(map(lambda oln: model.get_layer(oln).output, output_layer_names))
    )
    return enc_model
            </code></pre>
        </div>

        <div>Or if we want them all, we can do like:</div>
        <div class="code-snippet">
            <pre><code class="python">
def generate_encapsulate_model(model):
    enc_model = Model(
        inputs=model.input,
        # ignore 1st layer (input), since some old models do not have 1st layer as Keras layer
        outputs=list(map(lambda layer: layer.output, model.layers[1:]))
    )
    return enc_model
            </code></pre>
        </div>

        <div class="panel-heading"><i class="material-icons material-icons--outline">wb_sunny</i><b>Note:</b></div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    Do not include the <span class="highlight-text">input</span>
                    or <span class="highlight-text">input_layer</span>, since if the model is constructed by
                    using <span class="highlight-text">Model()</span>,
                    it is possible to have the input as an tensor (np array) instead of an actual Keras layer.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    Double check the layers you want, make sure you put them in a proper order.
                </li>
            </ul>
        </div>

        <div>Then we can generate our encapsulated model which contains multiple intermediate outputs:</div>
        <div class="code-snippet">
            <pre><code class="python">
enc_model = generate_encapsulate_model_with_output_layer_names(model, output_layer_names)
# OR
# enc_model = generate_encapsulate_model(model)
            </code></pre>
        </div>

        <div>We can try to predict an input sample with the encapsulated model:</div>
        <div class="code-snippet">
            <pre><code class="python">
print(enc_model.predict(input_sample))
            </code></pre>
        </div>

        <div>The output is a list which contains all output data of the layers we selected.</div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_predict_2.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 6</span> - Multiple list outputs after preprocessing
        </div>

        <div>The last output is the same as the one we predicted from the original model</div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_predict_3.png">
        <div class="img-label">
            <span class="img-label-number">Fig. 7</span> - Last list output is the same as the original inferences
        </div>

        <div class="sub-title" id="saveModel">3 Save encapsulated model</div>
        <div>For further conversion, we have to save the encapsulate model.</div>

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    For Keras, we don't need to compile the encapsulate model as long as we don't further train
                    the model. So don't worry too much about the arisen warning about model compiling.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    If you want to continue with the encapsulated model, feel free to put proper configurations.
                    Here, we just use "adam" and "sparse_categorical_crossentropy" as an example.
                </li>
            </ul>
        </div>

        <div class="code-snippet">
            <pre><code class="python">
enc_model.compile(optimizer='adam',
              loss='sparse_categorical_crossentropy',
              metrics=['accuracy'])
save_model(enc_model, "/PATH_TO_NEW_MODEL/enc_model.h5")
            </code></pre>
        </div>

        <div class="sub-title" id="convertModel">4 Convert to TensorSpace compatible model</div>
        <div>
            The last step is to convert the Keras model which contains multiple intermediate outputs to a TensorSpace
            compatible model by <a href="https://github.com/tensorflow/tfjs-converter">tfjs-converter</a>.
        </div>

        <div>The tfjs-converter can be used like:</div>
        <div class="code-snippet">
            <pre><code class="bash">
tensorflowjs_converter \
    --input_format=keras \
    ../models/enc_keras_model.h5 \
    ../models/json_models/keras
            </code></pre>
        </div>

        <img class="tag-img" src="../../assets/img/docs/Keras/Keras_models.png" alt="tfjs models">

        <div>
            <ul class="list-content">
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    There are two types of file generated:
                    <ul class="list-indent">
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            One "model.json" file which describe the structure of our model (defined multiple outputs)
                        </li>
                        <li class="panel-heading"><i class="material-icons">flare</i>
                            Some weight files which contains trained weights. The number of weight files is dependent on
                            the size and structure of the given model.
                        </li>
                    </ul>
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    By default, the structure file has the name "model.json" which you
                    <span class="span_bold">can</span> modify later.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    The weight files are named like "group1-shard1of1" which are used and written within the
                    "model.json" file. Hence we <span class="span_bold">DO NOT</span> suggest to modify the name of
                    weight files, unless really necessary. If you really want to modify them, please modify
                    the content in the ".json" (i.e. "model.json") as well.
                </li>
                <li class="panel-heading"><i class="material-icons">filter_center_focus</i>
                    For more detailed information about tfjs-converter, you can
                    visit <a href="https://github.com/tensorflow/tfjs-converter">tfjs-converter</a>.
                </li>
            </ul>

        </div>

        <div>
            If everything looks good, you shall be ready for the next step
            - <a href="basicLoad.html">Load a TensorSpace compatible model</a>
        </div>

    </main>
</div>

<footer>
    Copyright © 2018 TensorSpace.js. All rights reserved
</footer>

</body>

</html>
